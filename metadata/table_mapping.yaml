databases:
  - name: sqlserver_migration
    source_type: sqlserver
    source_db: "DSN=sqlserver_source"
    target_db: "postgresql://user:pass@host/db"
    enabled: true

    tables:
      # --- 1) Existing TABLE copy (unchanged behavior) ---
      - source: dbo.component_tool_mapping
        dest: public.component_mapping
        sort_columns: [created_at, id]     # table path still uses OFFSET; both cols ok
        where: "mapping_type IN ('it_business_application','version_control','work_management')"
        enabled: true
        # Optional: run BEFORE recreate (new feature)
        pre_ddl_file: "metadata/sql/pre_component_mapping.sql"
        # Runs after recreate (same timing as before, BEFORE copying data)
        post_ddl_file: "metadata/sql/component_mapping_repo_id.sql"
        transforms:
          plugins:
            - "metadata.transformers.component_mapping_repo_id.extract_git_coordinates"

      # --- 2) Arbitrary QUERY with KEYSET chunking (2 sort columns: sort + unique) ---
      - source: |
          SELECT uuid, updated, name, amount
          FROM dbo.source_view
        dest: public.source_view_dump
        sort_columns: [updated, uuid]      # keyset pagination (sort_field, unique_field)
        order: desc                        # optional: asc (default) | desc
        where: "amount IS NOT NULL"        # optional; applied to the wrapped subquery
        enabled: true
        # Optional schema helpers for query targets:
        pre_ddl_file: "metadata/sql/custom_target_schema.sql"
        post_ddl_file: "metadata/sql/post_process.sql"
        transforms:
          plugins:
            - "metadata.transformers.cleanup.normalize_keys"

      # --- 3) Arbitrary QUERY with OFFSET chunking (1 sort column) ---
      - source: |
          SELECT id, created_at, status
          FROM dbo.audit_log
        dest: public.audit_log_dump
        sort_columns: [created_at]         # single column => OFFSET/FETCH
        order: asc                         # optional
        enabled: true
        pre_ddl_file: "metadata/sql/audit_log_target.sql"
        # post_ddl_file optional
        transforms:
          plugins:
            - "metadata.transformers.audit.scrub_pii"
