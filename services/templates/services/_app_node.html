{% load tree_extras %}
{% with app=tree|get_item:app_id %}
    <details open>
        <summary>{{ app.app_name }} ({{ app_id }})</summary>

        <!-- Always show app metadata -->
        <div class="instance-meta" style="margin-left: 1rem; margin-bottom: 0.5rem;">
            <strong>Application Details</strong><br>
            ▪ Application Type: {{ app.application_type }}<br>
            ▪ Application Tier: {{ app.application_tier }}<br>
            ▪ Architecture Type: {{ app.architecture_type }}
        </div>

        <!-- Show instances if present -->
        {% if app.instances %}
            {% for instance in app.instances %}
                <div class="instance">
                    <strong>{{ instance.instance_name }}</strong>
                    <div class="instance-meta">
                        ▪ Environment: {{ instance.environment }}<br>
                        ▪ Install Type: {{ instance.install_type }}<br>
                        ▪ Service: {{ instance.service_name }}<br>
                        ▪ Jira Backlog: {{ instance.jira_backlog_id }}<br>
                        ▪ Application Type: {{ instance.application_type }}<br>
                        ▪ Application Tier: {{ instance.application_tier }}<br>
                        ▪ Architecture Type: {{ instance.architecture_type }}
                    </div>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Recursive children -->
        {% if app.children %}
            <ul>
                {% for child_id in app.children %}
                    <li>
                        {% include "services/_app_node.html" with app_id=child_id tree=tree %}
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
    </details>
{% endwith %}

