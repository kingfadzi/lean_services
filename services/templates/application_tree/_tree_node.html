<details class="tree">
    <summary>
        <strong>{{ node.name }}</strong> ({{ node.id }})
    </summary>

    <ul style="margin: 0.3rem 0; list-style-type: disc; padding-left: 1.5rem; font-size: 0.9em;">
        <li><strong>Type:</strong> {{ node.type|default:"—" }}</li>
        <li><strong>Tier:</strong> {{ node.tier|default:"—" }}</li>
        <li><strong>Architecture:</strong> {{ node.architecture|default:"—" }}</li>
        <li><strong>Lean Control ID:</strong> {{ node.lean_control_id|default:"—" }}</li>
        <li><strong>Jira Backlog ID:</strong> {{ node.jira_backlog_id|default:"—" }}</li>
        <li><strong>Business Service:</strong> {{ node.service_name|default:"—" }} ({{ node.service_id|default:"—" }})</li>
    </ul>

    {% if node.repositories %}
        {% with total_repos=0 %}
            {% for tool, repos in node.repositories.items %}
                {% if repos %}
                    {% with total_repos=total_repos|add:repos|length %}
                    {% endwith %}
                {% endif %}
            {% endfor %}
        {% endwith %}

        {% if total_repos > 0 %}
            <details class="tree" style="font-size: 0.9em;">
                <summary>Repositories ({{ total_repos }})</summary>
                <div style="padding-left: 1.5rem;">
                    {% for tool, repos in node.repositories.items %}
                        {% if repos %}
                            <details class="tree" style="margin-bottom: 0.5rem;">
                                <summary><strong>Tool: {{ tool|title }}</strong></summary>
                                <ul style="margin: 0.3rem 0; list-style-type: disc; padding-left: 1.5rem;">
                                    {% for repo in repos %}
                                        <li>{{ repo }}</li>
                                    {% endfor %}
                                </ul>
                            </details>
                        {% endif %}
                    {% endfor %}
                </div>
            </details>
        {% endif %}
    {% endif %}

    {% if node.instances_grouped %}
        <details class="tree" style="font-size: 0.9em;">
            <summary>Service Instances</summary>
            <div style="padding-left: 1.5rem;">
                {% for env, instances in node.instances_grouped.items %}
                    <details class="tree" style="margin-bottom: 0.5rem;">
                        <summary><strong>Environment: {{ env|default:"—" }}</strong></summary>
                        <ul style="margin: 0.3rem 0; list-style-type: disc; padding-left: 1.5rem;">
                            {% for inst in instances %}
                                <li>
                                    <strong>{{ inst.name|default:"Unnamed Instance" }}</strong><br>
                                    <small>ID: {{ inst.id }} | Type: {{ inst.install_type|default:"—" }}</small>
                                </li>
                            {% endfor %}
                        </ul>
                    </details>
                {% endfor %}
            </div>
        </details>
    {% endif %}

    {% for child in node.children %}
        {% include "application_tree/_tree_node.html" with node=child %}
    {% endfor %}
</details>
