<details class="tree">
    <summary>
        <strong>{{ node.name }}</strong> ({{ node.id }})
    </summary>

    <ul style="margin: 0.3rem 0; list-style-type: disc; padding-left: 1.5rem; font-size: 0.9em;">
        <li><strong>Type:</strong> {{ node.type|default:"—" }}</li>
        <li><strong>Tier:</strong> {{ node.tier|default:"—" }}</li>
        <li><strong>Architecture:</strong> {{ node.architecture|default:"—" }}</li>
        <li><strong>Lean Control ID:</strong> {{ node.lean_control_id|default:"—" }}</li>
        <li><strong>Jira Backlog ID:</strong> {{ node.jira_backlog_id|default:"—" }}</li>
        <li><strong>Business Service:</strong> {{ node.service_name|default:"—" }} ({{ node.service_id|default:"—" }})</li>
    </ul>

    {% if node.instances %}
        <details class="tree" style="font-size: 0.9em;">
            <summary>Service Instances ({{ node.instances|length }})</summary>
            <div style="padding-left: 1.5rem;">
                {% regroup node.instances by env as env_groups %}
                {% for group in env_groups %}
                    <details class="tree" style="margin-bottom: 0.5rem;">
                        <summary><strong>Environment: {{ group.grouper|default:"—" }}</strong></summary>
                        <ul style="margin: 0.3rem 0; list-style-type: disc; padding-left: 1.5rem;">
                            {% for inst in group.list %}
                                <li>
                                    <strong>{{ inst.name|default:"Unnamed Instance" }}</strong><br>
                                    <small>ID: {{ inst.id }} | Type: {{ inst.install_type|default:"—" }}</small>
                                </li>
                            {% endfor %}
                        </ul>
                    </details>
                {% endfor %}
            </div>
        </details>
    {% endif %}

    {% for child in node.children %}
        {% include "application_tree/_tree_node.html" with node=child %}
    {% endfor %}
</details>
