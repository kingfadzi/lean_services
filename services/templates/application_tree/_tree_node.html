<details class="tree">
    <summary>
        <strong>{{ node.name }}</strong> ({{ node.id }})
    </summary>

    <ul style="margin: 0.3rem 0; list-style-type: disc; padding-left: 1.5rem; font-size: 0.9em;">
        <li><strong>Application Type:</strong> {{ node.type|default:"—" }}</li>
        <li><strong>Tier:</strong> {{ node.tier|default:"—" }}</li>
        <li><strong>Owning Transaction Cycle:</strong> {{ node.owning_transaction_cycle|default:"—" }}</li>
        <li><strong>Operational Status:</strong> {{ node.operational_status|default:"—" }}</li>
        <li><strong>Architecture:</strong> {{ node.architecture|default:"—" }}</li>
        <li><strong>Lean Control ID:</strong> {{ node.lean_control_id|default:"—" }}</li>
        <li><strong>Jira Backlog ID:</strong> {{ node.jira_backlog_id|default:"—" }}</li>
        <li><strong>Business Service:</strong> {{ node.service_name|default:"—" }} ({{ node.service_id|default:"—" }})</li>
    </ul>

    {% if node.repo_count > 0 %}
        <details class="tree" style="font-size: 0.9em;">
            <summary>Repositories ({{ node.repo_count }})</summary>
            <div style="padding-left: 1.5rem;">
                {% for tool, repos in node.repo_pairs %}
                    <details class="tree" style="margin-bottom: 0.5rem;">
                        <summary><strong>Tool: {{ tool|title }}</strong></summary>
                        <ul style="margin: 0.3rem 0; list-style-type: disc; padding-left: 1.5rem;">
                            {% for repo in repos %}
                                <li>{{ repo }}</li>
                            {% endfor %}
                        </ul>
                    </details>
                {% endfor %}
            </div>
        </details>
    {% endif %}

    {% if node.instances_grouped %}
        <details class="tree" style="font-size: 0.9em;">
            <summary>Service Instances</summary>
            <div style="padding-left: 1.5rem;">
                {% for env, instances in node.instances_grouped.items %}
                    <details class="tree" style="margin-bottom: 0.5rem;">
                        <summary><strong>Environment: {{ env|default:"—" }}</strong> ({{ instances|length }})</summary>
                        <ul style="margin: 0.3rem 0; list-style-type: none; padding-left: 0;">
                            {% for inst in instances %}
                                <li class="instance" style="margin-bottom: 0.5rem;">
                                    <details class="tree">
                                        <summary>
                                            <strong>{{ inst.name|default:"Unnamed Instance" }}</strong>
                                            <small style="color:#64748b;">
                                                — ID: {{ inst.id }} | Type: {{ inst.install_type|default:"—" }}
                                            </small>
                                        </summary>

                                        {% with crs=inst.change_requests %}
                                            {% if crs and crs|length > 0 %}
                                                <details class="tree" style="margin-top: 0.25rem;">
                                                    <summary>Change Requests ({{ crs|length }})</summary>
                                                    <ul style="margin: 0.3rem 0; list-style-type: disc; padding-left: 1.5rem;">
                                                        {% for cr in crs %}
                                                            <li>{{ cr.task }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                </details>
                                            {% else %}
                                                <div style="margin-left: 1.5rem; font-size: 0.9em; color:#64748b; margin-top: 0.25rem;">
                                                    No change requests for this instance.
                                                </div>
                                            {% endif %}
                                        {% endwith %}
                                    </details>
                                </li>
                            {% endfor %}
                        </ul>
                    </details>
                {% endfor %}
            </div>
        </details>
    {% endif %}

    {% for child in node.children %}
        {% include "application_tree/_tree_node.html" with node=child %}
    {% endfor %}
</details>
