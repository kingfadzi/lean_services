stages:
  - validate
  - attest
  - policy_check
  - change_request
  - approval
  - deploy

variables:
  OPA_URL: "http://mars.butterflycluster.com:8181/v1/data/pipeline/allow"
  SERVICENOW_URL: "https://$SERVICENOW_INSTANCE.service-now.com/api/now/table/change_request"
  GIT_STRATEGY: clone

mock-validate-jira:
  stage: validate
  script: |
    echo '{ "ticket": "DASH-123", "status": "Open", "type": "Story" }' > validated_issues.json
    echo '{ "input": { "validated_jira": true, "has_high_severity": false, "license_compliant": true } }' > opa_input.json

  artifacts:
    paths:
      - validated_issues.json
      - opa_input.json

attest-validation:
  stage: attest
  image: alpine:3.20
  before_script:
    - apk add --no-cache curl jq
    - COSIGN_VERSION=$(curl -s https://api.github.com/repos/sigstore/cosign/releases/latest | jq -r .tag_name)
    - curl -L -o cosign "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64"
    - chmod +x cosign
    - mv cosign /usr/local/bin/
  script: |
    echo "ğŸ” Generating ephemeral signing key..."
    cosign generate-key-pair

    echo "âœï¸  Signing opa_input.json..."
    cosign sign-blob --key cosign.key --output-signature opa_input.sig --tlog-upload=false opa_input.json
    echo "âœ… Signature complete."
  artifacts:
    paths:
      - opa_input.json
      - opa_input.sig
      - cosign.pub

policy-check:
  stage: policy_check
  image: alpine:3.20
  dependencies:
    - attest-validation
  before_script:
    - apk add --no-cache curl jq
    - COSIGN_VERSION=$(curl -s https://api.github.com/repos/sigstore/cosign/releases/latest | jq -r .tag_name)
    - curl -L -o cosign "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64"
    - chmod +x cosign
    - mv cosign /usr/local/bin/
  script: |
    echo "ğŸ” Verifying signature before policy check..."
    ls -lh
    sha256sum opa_input.json opa_input.sig || true

    cosign verify-blob \
      --offline \
      --key cosign.pub \
      --signature opa_input.sig \
      --insecure-ignore-tlog \
      opa_input.json

    echo "âœ… Signature verified. Sending raw input to OPA..."
    curl -s -X POST -H "Content-Type: application/json" \
      -d @opa_input.json "$OPA_URL" > opa_result.json

    echo "ğŸ“„ OPA Result:"
    cat opa_result.json

    echo "ğŸ§ª Evaluating policy outcome..."
    jq -e '.result == true' opa_result.json || {
      echo "âŒ Policy denied the input. Failing pipeline."
      exit 1
    }
  artifacts:
    paths:
      - opa_result.json


request-cr:
  stage: change_request
  image: registry.access.redhat.com/ubi8/ubi:latest
  script: |
    echo "ğŸ“¤ Creating Change Request in ServiceNow..."
    response=$(curl --fail -X POST "$SERVICENOW_URL" \
      -H "Content-Type: application/json" \
      -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
      -d @opa_input.json)

    echo "âœ… Response from ServiceNow:"
    echo "$response" > cr_response.json
    cat cr_response.json
  artifacts:
    paths:
      - cr_response.json


wait-for-approval:
  stage: approval
  image: registry.access.redhat.com/ubi8/ubi:latest
  dependencies:
    - request-cr
  script: |
    echo "â³ Waiting for Change Request approval in ServiceNow..."

    # Extract sys_id from previous response
    CR_SYS_ID=$(jq -r '.result.sys_id' cr_response.json)

    if [ -z "$CR_SYS_ID" ] || [ "$CR_SYS_ID" == "null" ]; then
      echo "âŒ Failed to extract sys_id from ServiceNow response."
      cat cr_response.json
      exit 1
    fi

    echo "ğŸ” Monitoring CR sys_id: $CR_SYS_ID"

    for i in {1..40}; do  # Up to 20 minutes with 30s intervals
      CR_STATUS=$(curl -s -u "$SERVICENOW_USERNAME:$SERVICENOW_PASSWORD" \
        "$SERVICENOW_URL/$CR_SYS_ID" | jq -r '.result.state')

      case "$CR_STATUS" in
        "3")  # Approved
          echo "âœ… Change Request approved. Proceeding with deployment."
          exit 0
          ;;
        "4")  # Rejected
          echo "âŒ Change Request rejected. Halting pipeline."
          exit 1
          ;;
        *)
          echo "ğŸ” Current CR state: $CR_STATUS. Waiting..."
          sleep 30
          ;;
      esac
    done

    echo "â° Timeout waiting for CR approval after 20 minutes."
    exit 1


deploy:
  stage: deploy
  script: |
    echo '{ "status": "success", "timestamp": "'$(date)'" }' > deployment_metadata.json
  artifacts:
    paths:
      - deployment_metadata.json
