stages:
  - validate
  - attest
  - policy_check
  - change_request
  - approval
  - deploy

variables:
  OPA_URL: "http://mars.butterflycluster.com:8181/v1/data/pipeline/allow"
  SERVICENOW_URL: "https://$SERVICENOW_INSTANCE.service-now.com/api/now/table/change_request"
  GIT_STRATEGY: clone

mock-validate-jira:
  stage: validate
  script: |
    echo '{ "ticket": "DASH-123", "status": "Open", "type": "Story" }' > validated_issues.json
    echo '{ "validated_jira": true, "has_high_severity": false, "license_compliant": true }' > opa_input.json
  artifacts:
    paths:
      - validated_issues.json
      - opa_input.json

attest-validation:
  stage: attest
  image: alpine:3.20
  before_script:
    - apk add --no-cache curl jq
    - COSIGN_VERSION=$(curl -s https://api.github.com/repos/sigstore/cosign/releases/latest | jq -r .tag_name)
    - curl -L -o cosign "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64"
    - chmod +x cosign
    - mv cosign /usr/local/bin/
  script: |
    echo "🔐 Generating ephemeral signing key..."
    # Generate key-pair (outputs cosign.key and cosign.pub in current directory)
    cosign generate-key-pair

    echo "✍️  Signing opa_input.json..."
    cosign sign-blob --key cosign.key \
      --output-signature opa_input.sig \
      opa_input.json

    echo "✅ Signature complete."
  artifacts:
    paths:
      - opa_input.sig
      - cosign.pub



policy-check:
  stage: policy_check
  image: cgr.dev/chainguard/cosign:latest
  script: |
    echo "🔍 Verifying signature before policy check..."
    cosign verify-blob \
      --key cosign.pub \
      --signature opa_input.sig \
      opa_input.json

    echo "✅ Signature verified. Sending input to OPA..."
    curl -s -X POST -H "Content-Type: application/json" -d @opa_input.json $OPA_URL > opa_result.json
    cat opa_result.json
    jq '.result.allow' opa_result.json | grep true || exit 1
  artifacts:
    paths:
      - opa_result.json

request-cr:
  stage: change_request
  script: |
    curl -s -X POST "$SERVICENOW_URL" \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer $SERVICENOW_TOKEN" \
      -d @opa_input.json > cr_response.json
  artifacts:
    paths:
      - cr_response.json

manual-approval:
  stage: approval
  script: |
    echo "Manual approval step, use GitLab UI"
  when: manual
  allow_failure: false

deploy:
  stage: deploy
  script: |
    echo '{ "status": "success", "timestamp": "'$(date)'" }' > deployment_metadata.json
  artifacts:
    paths:
      - deployment_metadata.json
